name: "Release dev container features & Generate Documentation"
on:
  workflow_run:
    workflows: ["CI - Test Features for main push"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.ref == 'refs/heads/main' && (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Bump Feature Versions"
        run: |
          set -eo pipefail
          while IFS= read -r file; do
            feature_dir=$(dirname "$file")
            # Get the last commit that changed the "version" line in the json file
            last_bump_commit=$(git log -G '"version": "' -1 --format=%H -- "$file")
            
            should_bump=false
            if [ -z "$last_bump_commit" ]; then
              echo "No version change history found for $file. Bumping version."
              should_bump=true
            else
              # Check for any commits in the feature directory since the last version bump
              # (excluding the version bump commit itself)
              changes=$(git log "${last_bump_commit}..HEAD" --oneline -- "$feature_dir")
              if [ -n "$changes" ]; then
                echo "Changes detected in $feature_dir since last version bump ($last_bump_commit):"
                echo "$changes"
                should_bump=true
              else
                echo "No changes detected in $feature_dir since last version bump."
              fi
            fi

            if [ "$should_bump" = "true" ]; then
              echo "Bumping version for $file"
              tmp=$(mktemp)
              # Increment patch version (index 2) after validating semantic version format (major.minor.patch)
              jq '.version |= (if test("^[0-9]+\\.[0-9]+\\.[0-9]+$") then (split(".") | map(tonumber) | .[2] += 1 | map(tostring) | join(".")) else error("Invalid semantic version format for .version") end)' "$file" > "$tmp" && mv "$tmp" "$file"
              echo "New version: $(jq -r .version "$file")"
            fi
          done < <(find src -name "devcontainer-feature.json")

      - name: "Publish Features"
        uses: devcontainers/action@v1
        with:
          publish-features: "true"
          base-path-to-features: "./src"
          generate-docs: "true"
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR for Documentation and Version Bump
        id: push_image_info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "Start."
          # Configure git and Push updates
          git config --global user.email github-actions[bot]@users.noreply.github.com
          git config --global user.name github-actions[bot]
          git config pull.rebase false
          branch=automated-documentation-update-$GITHUB_RUN_ID
          git checkout -b $branch
          message='Automated documentation update and version bump'
          # Add / update and commit
          git add src/**/README.md src/**/devcontainer-feature.json
          git commit -m 'Automated documentation update and version bump [skip ci]' || export NO_UPDATES=true
          # Push
          if [ "$NO_UPDATES" != "true" ] ; then
              git push origin "$branch"
              gh pr create --title "$message" --body "$message"
          fi